# YouTubeプレイリスト更新通知システム

## 概要

このGoogle Apps Script (GAS) は、指定されたYouTubeプレイリストの動画数を定期的にチェックし、動画数が増加した場合にLINEで通知を送るシステムです。
管理はGoogleスプレッドシートで行います。

## 機能

-   Googleスプレッドシートで監視対象のYouTubeプレイリストを管理します（プレイリスト名、URL、現在の動画数）。
-   YouTube Data APIを使用して、各プレイリストの現在の動画数を取得します。
-   スプレッドシートに記録されている動画数と比較し、増加した場合にLINE Messaging APIを通じて指定のLINEアカウント（ユーザーまたはグループ）に通知を送信します。
-   動画数が変化した場合（増加または減少）、スプレッドシートの動画数を最新の値に更新します。
-   GASの時間主導型トリガーにより、定期的に自動実行されます。

## 必要なもの

1.  **Googleアカウント**: GAS、Googleスプレッドシートを使用するために必要です。
2.  **YouTube Data APIキー**: Google Cloud Platformで取得します。
3.  **LINE Messaging API アクセストークン**: LINE Developersコンソールで取得します。
4.  **LINEユーザーIDまたはグループID**: 通知を送信したい対象のID。
5.  **Googleスプレッドシート**: プレイリスト情報を管理するために使用します。

## 設定手順

### 1. Googleスプレッドシートの準備

1.  新しいGoogleスプレッドシートを作成します。
2.  シート名を任意の名前に変更します（例: `プレイリスト一覧`）。この名前は後でGASのスクリプトプロパティに設定します。
3.  1行目にヘッダーを設定します。
    *   **A列**: プレイリスト名 (例: `お気に入り音楽`)
    *   **B列**: プレイリストURL (例: `https://www.youtube.com/playlist?list=PLxxxxxxxxxxxxxxx`)
    *   **C列**: 動画数 (初回は空欄または `0` を入力)
4.  2行目以降に、監視したいプレイリストの情報を入力します。
5.  スプレッドシートのURLから **スプレッドシートID** を控えておきます。
    *   例: `https://docs.google.com/spreadsheets/d/`**`ここに表示されるID`**`/edit`

### 2. Google Apps Script プロジェクトの作成とコードのコピー

1.  Googleドライブで「新規」>「その他」>「Google Apps Script」を選択し、新しいスクリプトプロジェクトを作成します。
2.  プロジェクトに名前を付けます（例: `YouTubeプレイリスト更新通知`）。
3.  デフォルトで表示される `コード.gs` の内容をすべて削除し、提供された `Code.gs` ファイルの内容を貼り付けます。
4.  （任意）設定項目をメモするために、`config.gs` ファイルの内容を参考にできますが、このファイル自体をプロジェクトに追加する必要はありません。

### 3. スクリプトプロパティの設定

1.  GASエディタの左メニューから「プロジェクトの設定」（歯車アイコン）をクリックします。
2.  「スクリプト プロパティ」セクションで、「スクリプト プロパティを追加」をクリックし、以下のキーと値を設定します。
    *   `YOUTUBE_API_KEY`: 取得したYouTube Data APIキー
    *   `LINE_ACCESS_TOKEN`: 取得したLINE Messaging APIのチャネルアクセストークン
    *   `LINE_USER_ID`: 通知を送りたいLINEユーザーIDまたはグループID
    *   `SPREADSHEET_ID`: 手順1で控えたGoogleスプレッドシートのID
    *   `SHEET_NAME`: 手順1で設定したシート名（例: `プレイリスト一覧`）
3.  設定したら、「スクリプト プロパティを保存」をクリックします。

### 4. 必要なAPIサービスの有効化

1.  GASエディタの左メニューから「サービス」（＋アイコン）をクリックします。
2.  「Google Sheets API」を探し、「追加」をクリックします。

### 5. トリガーの設定

1.  GASエディタの左メニューから「トリガー」（目覚まし時計アイコン）をクリックします。
2.  右下の「トリガーを追加」ボタンをクリックします。
3.  以下の項目を設定します。
    *   **実行する関数を選択**: `checkPlaylists`
    *   **実行するデプロイを選択**: `Head`
    *   **イベントのソースを選択**: `時間主導型`
    *   **時間ベースのトリガーのタイプを選択**: 実行したい頻度を選択します（例: `日付ベースのタイマー` > `午前1時～2時` など、毎日1回実行する場合）。APIの割り当て制限に注意してください。
    *   **エラー通知設定**: 必要に応じて設定します（例: `今すぐ通知を受け取る`）。
4.  「保存」をクリックします。
5.  初回設定時には、Googleアカウントへのアクセス許可を求められます。内容を確認し、「許可」をクリックしてください。（「このアプリはGoogleで確認されていません」と表示された場合は、「詳細」をクリックし、「（プロジェクト名）（安全ではないページ）に移動」をクリックして許可を進めてください。）

これで設定は完了です。指定した時間になるとスクリプトが自動実行され、プレイリストの動画数が増えていればLINEに通知が届きます。

## コードの説明 (`Code.gs`)

-   **`CONFIG`**: スクリプトプロパティから各種設定値を読み込みます。
-   **`checkPlaylists()`**: メイン関数。トリガーから呼び出され、全体の処理フロー（シート読み込み → ID抽出 → API呼び出し → 比較 → 通知/更新）を実行します。
-   **`getPlaylistInfo(playlistId)`**: YouTube Data APIを呼び出し、指定されたプレイリストIDの動画数とタイトルを取得します。
-   **`sendLineNotification(message)`**: LINE Messaging APIを呼び出し、指定されたメッセージをプッシュ通知します。
-   **`getPlaylistsFromSheet()`**: スプレッドシートから監視対象のプレイリスト情報を読み込みます。
-   **`updateVideoCountInSheet(rowIndex, newCount)`**: スプレッドシートの指定された行の動画数を更新します。
-   **`extractPlaylistIdFromUrl(url)`**: YouTubeのプレイリストURLからプレイリストIDを抽出します。

## 運用とメンテナンス

-   **プレイリストの追加/削除**: スプレッドシートを編集することで、監視対象のプレイリストを自由に追加・削除できます。
-   **APIキー/トークンの更新**: APIキーやアクセストークンの有効期限が切れた場合、スクリプトプロパティを更新する必要があります。
-   **API仕様変更**: YouTube APIやLINE APIの仕様が変更された場合、スクリプトの修正が必要になる可能性があります。
-   **エラーログ**: GASエディタの「実行数」メニューから、スクリプトの実行履歴やエラーログを確認できます。問題発生時のデバッグに役立ちます。
-   **API割り当て**: 各APIには無料利用枠や割り当て制限があります。監視するプレイリスト数や実行頻度によっては、制限を超える可能性があるため注意が必要です。




## テストとデバッグ

### 1. 手動実行によるテスト

トリガーを設定する前に、スクリプトが正しく動作するか手動でテストすることをお勧めします。

1.  **GASエディタを開く**: スクリプトプロジェクトを開きます。
2.  **実行する関数を選択**: エディタ上部のドロップダウンメニューから `checkPlaylists` を選択します。
3.  **実行ボタンをクリック**: ▶ (実行) ボタンをクリックします。
4.  **承認**: 初めて実行する場合や、新しいAPIサービス（Google Sheets APIなど）を追加した後は、承認を求められます。画面の指示に従って許可してください。（「このアプリはGoogleで確認されていません」と表示された場合は、「詳細」をクリックし、「（プロジェクト名）（安全ではないページ）に移動」をクリックして許可を進めてください。）
5.  **実行ログの確認**: 実行後、エディタ下部の実行ログ（またはメニューの「表示」>「ログ」）を確認し、エラーが発生していないか、意図した通りに処理が進んでいるか（プレイリスト情報の取得、動画数の比較、LINE通知の試行など）を確認します。

### 2. テストケース例

以下のケースでテストを実施し、動作を確認してください。

-   **動画数に変更がない場合**: スプレッドシートに登録したプレイリストの動画数を変更せずに `checkPlaylists` を実行します。LINE通知が送信されず、スプレッドシートの値も変わらないことを確認します。
-   **動画数が増加した場合**: テスト用のプレイリストに新しい動画を追加し、`checkPlaylists` を実行します。LINEに通知が届き、スプレッドシートの該当行の動画数が更新されることを確認します。
-   **動画数が減少した場合**: テスト用のプレイリストから動画を削除し、`checkPlaylists` を実行します。LINE通知は送信されませんが、スプレッドシートの該当行の動画数が更新されることを確認します。
-   **不正なURL/ID**: スプレッドシートに意図的に不正な形式のURLや存在しないプレイリストのURLを入力し、`checkPlaylists` を実行します。実行ログにエラーメッセージ（ID抽出失敗やAPI取得失敗など）が記録され、他の正常なプレイリストの処理は継続されることを確認します。
-   **APIキー/トークンエラー**: スクリプトプロパティにわざと間違ったAPIキーやトークンを設定し、`checkPlaylists` を実行します。実行ログに関連するAPIエラー（認証失敗など）が記録されることを確認します。
-   **スプレッドシート/シート名エラー**: スクリプトプロパティに間違ったスプレッドシートIDやシート名を設定し、`checkPlaylists` を実行します。実行ログにスプレッドシートやシートが見つからない旨のエラーが記録されることを確認します。

### 3. デバッグ方法

問題が発生した場合、以下の方法でデバッグを行います。

-   **実行ログの確認**: 最も基本的なデバッグ方法です。GASエディタの左メニュー「実行数」から、各実行の詳細と `Logger.log()` で出力した内容を確認できます。エラーメッセージが表示されている場合は、その内容をよく読んで原因を特定します。
-   **`Logger.log()` の活用**: コード内の特定の変数の中身を確認したい場合や、処理がどこまで進んでいるかを確認したい場合に、`Logger.log("メッセージ: " + 変数名);` のような形でログ出力コードを追加します。これにより、実行時の詳細な情報を得ることができます。
-   **APIレスポンスの確認**: YouTube APIやLINE APIの呼び出しでエラーが発生している場合、`UrlFetchApp.fetch` の `muteHttpExceptions: true` オプションにより、エラーステータスコードやレスポンスボディがログに出力されるようにしています。ログを確認し、APIからどのようなエラーが返されているかを確認します。
-   **権限の確認**: スクリプトが必要とする権限（スプレッドシートへのアクセス、外部サービスへの接続など）が正しく付与されているか確認します。必要であれば、再度承認プロセスを実行します。
-   **各関数の単体テスト**: 問題の切り分けのため、`getPlaylistInfo`, `sendLineNotification`, `getPlaylistsFromSheet`, `updateVideoCountInSheet`, `extractPlaylistIdFromUrl` などの関数を、GASエディタから個別に実行してテストすることも有効です。その際は、テスト用の引数を直接指定して実行します。


